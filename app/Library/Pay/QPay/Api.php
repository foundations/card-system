<?php
namespace App\Library\Pay\QPay; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; require_once __DIR__ . '/qpay_mch_sp/qpayMchAPI.class.php'; class Api implements ApiInterface { private $url_notify = ''; public function __construct($sp7a2170) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp7a2170; } function goPay($sp54f11a, $spd2bbfa, $sp942f8c, $spd86457, $sp5f71a2) { if (!isset($sp54f11a['mch_id']) || !isset($sp54f11a['mch_key'])) { throw new \Exception('请设置 mch_id 和 mch_key'); } $sp636f0e = array('out_trade_no' => $spd2bbfa, 'body' => $sp942f8c, 'device_info' => 'qq_19060', 'fee_type' => 'CNY', 'notify_url' => $this->url_notify, 'spbill_create_ip' => Helper::getIP(), 'total_fee' => $sp5f71a2, 'trade_type' => 'NATIVE'); $spdf60f3 = new \QpayMchAPI('https://qpay.qq.com/cgi-bin/pay/qpay_unified_order.cgi', null, 10); $sp1b9fe8 = $spdf60f3->req($sp636f0e, $sp54f11a); $spfe67da = \QpayMchUtil::xmlToArray($sp1b9fe8); if (!isset($spfe67da['code_url'])) { Log::error('Pay.QPay.goPay, order_no:' . $spd2bbfa . ', error:' . json_encode($spfe67da)); if (isset($spfe67da['err_code_des'])) { throw new \Exception($spfe67da['err_code_des']); } if (isset($spfe67da['return_msg'])) { throw new \Exception($spfe67da['return_msg']); } throw new \Exception('获取支付数据失败'); } header('location: /qrcode/pay/' . $spd2bbfa . '/qq?url=' . urlencode($spfe67da['code_url'])); die; } function verify($sp54f11a, $sp0a40c9) { $sp60916b = isset($sp54f11a['isNotify']) && $sp54f11a['isNotify']; $spdf60f3 = new \QpayMchAPI('https://qpay.qq.com/cgi-bin/pay/qpay_order_query.cgi', null, 10); if ($sp60916b) { $sp636f0e = $spdf60f3->notify_params(); if (!$spdf60f3->notify_verify($sp636f0e, $sp54f11a)) { echo '<xml><return_code>FAIL</return_code></xml>'; return false; } call_user_func_array($sp0a40c9, array($sp636f0e['out_trade_no'], $sp636f0e['total_fee'], $sp636f0e['transaction_id'])); echo '<xml><return_code>SUCCESS</return_code></xml>'; return true; } else { $spd2bbfa = @$sp54f11a['out_trade_no']; $sp636f0e = array('out_trade_no' => $spd2bbfa); $sp1b9fe8 = $spdf60f3->req($sp636f0e, $sp54f11a); $spfe67da = \QpayMchUtil::xmlToArray($sp1b9fe8); if (array_key_exists('trade_state', $spfe67da) && $spfe67da['trade_state'] == 'SUCCESS') { call_user_func_array($sp0a40c9, array($spfe67da['out_trade_no'], $spfe67da['total_fee'], $spfe67da['transaction_id'])); return true; } else { return false; } } } }
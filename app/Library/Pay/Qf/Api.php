<?php
namespace App\Library\Pay\Qf; use App\Library\CurlRequest as Request; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp7a2170) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp7a2170; $this->url_return = SYS_URL . '/pay/return/' . $sp7a2170; } function goPay($sp54f11a, $spd2bbfa, $sp942f8c, $spd86457, $sp5f71a2) { $sp8339d0 = strtolower($sp54f11a['payway']); if (!isset($sp54f11a['id'])) { throw new \Exception('请设置 id'); } $spfc203b = array(); if ($sp8339d0 == 'qq') { $spfc203b = array('User-Agent' => 'Mozilla/5.0 Mobile MQQBrowser/6.2 QQ/7.2.5.3305'); } elseif ($sp8339d0 == 'alipay') { $spfc203b = array('User-Agent' => 'Mozilla/5.0 AlipayChannelId/5136 AlipayDefined(nt:WIFI,ws:411|0|2.625) AliApp(AP/10.1.10.1226101) AlipayClient/10.1.10.1226101'); } $sp57b59a = ''; $spa2aea3 = Request::get('https://o2.qfpay.com/q/info?code=&huid=' . $sp54f11a['id'] . '&opuid=&reqid=' . $spd2bbfa, $sp57b59a, $spfc203b); $spe4f7b4 = static::strBetween($spa2aea3, 'reqid":"', '"'); $spb9ca57 = static::strBetween($spa2aea3, 'currency":"', '"'); if ($spe4f7b4 == '' || $spb9ca57 == '') { Log::error('qfpay pay, 获取支付金额失败 - ' . $spa2aea3); throw new \Exception('获取支付请求id失败'); } $sp1c6dbb = Request::post('https://o2.qfpay.com/q/payment', 'txamt=' . $sp5f71a2 . '&openid=&appid=&huid=' . $sp54f11a['id'] . '&opuid=&reqid=' . $spe4f7b4 . '&balance=0&currency=' . $spb9ca57, $sp57b59a, $spfc203b); $spfe67da = json_decode($sp1c6dbb, true); $spf82902 = static::strBetween($sp1c6dbb, 'syssn":"', '"'); if (!$spfe67da || $spf82902 == '') { Log::error('qfpay pay, 生成支付单号失败#1 - ' . $sp1c6dbb); throw new \Exception('生成支付单号失败#1'); } if ($spfe67da['respcd'] !== '0000') { if (isset($spfe67da['respmsg']) && $spfe67da['respmsg'] !== '') { throw new \Exception($spfe67da['respmsg']); } Log::error('qfpay pay, 生成支付单号失败#2 - ' . $sp1c6dbb); throw new \Exception('生成支付单号失败#2'); } \App\Order::whereOrderNo($spd2bbfa)->update(array('pay_trade_no' => $spf82902)); header('location: /qrcode/pay/' . $spd2bbfa . '/qf_' . $sp8339d0 . '?url=' . urlencode(json_encode($spfe67da['data']['pay_params']))); } function verify($sp54f11a, $sp0a40c9) { $spc73e3b = \App\Order::whereOrderNo($sp54f11a['out_trade_no'])->firstOrFail(); $spf82902 = $spc73e3b->pay_trade_no; $spe7092d = Request::get('https://marketing.qfpay.com/v1/mkw/activity?syssn=' . $spf82902); $sp8cbf9d = json_decode($spe7092d, true); if (!$spe7092d) { throw new \Exception('query error'); } if (!isset($sp8cbf9d['respcd'])) { Log::error('qfpay query, 获取支付结果失败 - ' . $spe7092d); throw new \Exception('获取支付结果失败'); } if ($sp8cbf9d['respcd'] !== '0000') { return false; } $sp85fdf2 = (int) static::strBetween($spe7092d, 'trade_amt":', ','); if ($sp85fdf2 === 0) { $sp85fdf2 = (int) static::strBetween($spe7092d, 'txamt":', ','); if ($sp85fdf2 === 0) { Log::error('qfpay query, 获取支付金额失败 - ' . $spe7092d); throw new \Exception('获取支付金额失败'); } } if ($sp8cbf9d['respcd'] === '0000') { $sp0a40c9($sp54f11a['out_trade_no'], $sp85fdf2, $spf82902); return true; } return false; } public static function strBetween($spba2cdb, $spc55008, $sp76d7f5) { $spa71564 = stripos($spba2cdb, $spc55008); if ($spa71564 === false) { return ''; } $sp6b36c9 = stripos($spba2cdb, $sp76d7f5, $spa71564 + strlen($spc55008)); if ($sp6b36c9 === false || $spa71564 >= $sp6b36c9) { return ''; } $sp037d6e = strlen($spc55008); $sp27b5c4 = substr($spba2cdb, $spa71564 + $sp037d6e, $sp6b36c9 - $spa71564 - $sp037d6e); return $sp27b5c4; } }
<?php
require_once '../lib/WxPay.Api.php'; class MicroPay { public function pay($sp84c7ea) { $spfe67da = WxPayApi::micropay($sp84c7ea, 5); if (!array_key_exists('return_code', $spfe67da) || !array_key_exists('out_trade_no', $spfe67da) || !array_key_exists('result_code', $spfe67da)) { echo '接口调用失败,请确认是否输入是否有误！'; throw new WxPayException('接口调用失败！'); } $spd2bbfa = $sp84c7ea->GetOut_trade_no(); if ($spfe67da['return_code'] == 'SUCCESS' && $spfe67da['result_code'] == 'FAIL' && $spfe67da['err_code'] != 'USERPAYING' && $spfe67da['err_code'] != 'SYSTEMERROR') { return false; } $speaea65 = 10; while ($speaea65 > 0) { $sp000d20 = 0; $spa864cf = $this->query($spd2bbfa, $sp000d20); if ($sp000d20 == 2) { sleep(2); continue; } else { if ($sp000d20 == 1) { return $spa864cf; } else { return false; } } } if (!$this->cancel($spd2bbfa)) { throw new WxpayException('撤销单失败！'); } return false; } public function query($spd2bbfa, &$spbc4413) { $sp409b23 = new WxPayOrderQuery(); $sp409b23->SetOut_trade_no($spd2bbfa); $spfe67da = WxPayApi::orderQuery($sp409b23); if ($spfe67da['return_code'] == 'SUCCESS' && $spfe67da['result_code'] == 'SUCCESS') { if ($spfe67da['trade_state'] == 'SUCCESS') { $spbc4413 = 1; return $spfe67da; } else { if ($spfe67da['trade_state'] == 'USERPAYING') { $spbc4413 = 2; return false; } } } if ($spfe67da['err_code'] == 'ORDERNOTEXIST') { $spbc4413 = 0; } else { $spbc4413 = 2; } return false; } public function cancel($spd2bbfa, $sp68195c = 0) { if ($sp68195c > 10) { return false; } $sp2bce7e = new WxPayReverse(); $sp2bce7e->SetOut_trade_no($spd2bbfa); $spfe67da = WxPayApi::reverse($sp2bce7e); if ($spfe67da['return_code'] != 'SUCCESS') { return false; } if ($spfe67da['result_code'] != 'SUCCESS' && $spfe67da['recall'] == 'N') { return true; } else { if ($spfe67da['recall'] == 'Y') { return $this->cancel($spd2bbfa, ++$sp68195c); } } return false; } }
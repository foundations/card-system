<?php
require_once '../lib/WxPay.Api.php'; class JsApiPay { public $data = null; public function GetOpenid() { if (!isset($_GET['code'])) { $sp3590f7 = urlencode('http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] . $_SERVER['QUERY_STRING']); $spadfef0 = $this->__CreateOauthUrlForCode($sp3590f7); Header("Location: {$spadfef0}"); die; } else { $sp89b33d = $_GET['code']; $sp2cc24e = $this->getOpenidFromMp($sp89b33d); return $sp2cc24e; } } public function GetJsApiParameters($spf76fcc) { if (!array_key_exists('appid', $spf76fcc) || !array_key_exists('prepay_id', $spf76fcc) || $spf76fcc['prepay_id'] == '') { throw new WxPayException('参数错误'); } $sp1c4500 = new WxPayJsApiPay(); $sp1c4500->SetAppid($spf76fcc['appid']); $sp40c13e = time(); $sp1c4500->SetTimeStamp("{$sp40c13e}"); $sp1c4500->SetNonceStr(WxPayApi::getNonceStr()); $sp1c4500->SetPackage('prepay_id=' . $spf76fcc['prepay_id']); $sp1c4500->SetSignType('MD5'); $sp1c4500->SetPaySign($sp1c4500->MakeSign()); $sp1daf8f = json_encode($sp1c4500->GetValues()); return $sp1daf8f; } public function GetOpenidFromMp($sp89b33d) { $spadfef0 = $this->__CreateOauthUrlForOpenid($sp89b33d); $spe77a27 = curl_init(); curl_setopt($spe77a27, CURLOPT_TIMEOUT, $this->curl_timeout); curl_setopt($spe77a27, CURLOPT_URL, $spadfef0); curl_setopt($spe77a27, CURLOPT_SSL_VERIFYPEER, FALSE); curl_setopt($spe77a27, CURLOPT_SSL_VERIFYHOST, FALSE); curl_setopt($spe77a27, CURLOPT_HEADER, FALSE); curl_setopt($spe77a27, CURLOPT_RETURNTRANSFER, TRUE); if (WxPayConfig::CURL_PROXY_HOST != '0.0.0.0' && WxPayConfig::CURL_PROXY_PORT != 0) { curl_setopt($spe77a27, CURLOPT_PROXY, WxPayConfig::CURL_PROXY_HOST); curl_setopt($spe77a27, CURLOPT_PROXYPORT, WxPayConfig::CURL_PROXY_PORT); } $sp5f9727 = curl_exec($spe77a27); curl_close($spe77a27); $sp2bb3bd = json_decode($sp5f9727, true); $this->data = $sp2bb3bd; $sp2cc24e = $sp2bb3bd['openid']; return $sp2cc24e; } private function ToUrlParams($sp71df00) { $sp7fb8ad = ''; foreach ($sp71df00 as $spc20e8d => $spc86f28) { if ($spc20e8d != 'sign') { $sp7fb8ad .= $spc20e8d . '=' . $spc86f28 . '&'; } } $sp7fb8ad = trim($sp7fb8ad, '&'); return $sp7fb8ad; } public function GetEditAddressParameters() { $spc56ce4 = $this->data; $sp2bb3bd = array(); $sp2bb3bd['appid'] = WxPayConfig::APPID; $sp2bb3bd['url'] = 'http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $sp6547f3 = time(); $sp2bb3bd['timestamp'] = "{$sp6547f3}"; $sp2bb3bd['noncestr'] = '1234568'; $sp2bb3bd['accesstoken'] = $spc56ce4['access_token']; ksort($sp2bb3bd); $sp636f0e = $this->ToUrlParams($sp2bb3bd); $sp54ea01 = sha1($sp636f0e); $spdf5e3a = array('addrSign' => $sp54ea01, 'signType' => 'sha1', 'scope' => 'jsapi_address', 'appId' => WxPayConfig::APPID, 'timeStamp' => $sp2bb3bd['timestamp'], 'nonceStr' => $sp2bb3bd['noncestr']); $sp1daf8f = json_encode($spdf5e3a); return $sp1daf8f; } private function __CreateOauthUrlForCode($sp58b8cc) { $sp71df00['appid'] = WxPayConfig::APPID; $sp71df00['redirect_uri'] = "{$sp58b8cc}"; $sp71df00['response_type'] = 'code'; $sp71df00['scope'] = 'snsapi_base'; $sp71df00['state'] = 'STATE' . '#wechat_redirect'; $sp6f0911 = $this->ToUrlParams($sp71df00); return 'https://open.weixin.qq.com/connect/oauth2/authorize?' . $sp6f0911; } private function __CreateOauthUrlForOpenid($sp89b33d) { $sp71df00['appid'] = WxPayConfig::APPID; $sp71df00['secret'] = WxPayConfig::APPSECRET; $sp71df00['code'] = $sp89b33d; $sp71df00['grant_type'] = 'authorization_code'; $sp6f0911 = $this->ToUrlParams($sp71df00); return 'https://api.weixin.qq.com/sns/oauth2/access_token?' . $sp6f0911; } }
<?php
namespace App\Library\Pay\WeChat; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp7a2170) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp7a2170; $this->url_return = SYS_URL . '/pay/return/' . $sp7a2170; } function goPay($sp54f11a, $spd2bbfa, $sp942f8c, $spd86457, $sp5f71a2) { $sp488d84 = $sp5f71a2; $sp286f3b = strtoupper($sp54f11a['payway']); if (strpos(@$_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false) { $sp286f3b = 'JSAPI'; $spd7f811 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $spd2bbfa; $sp05569a = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' . $sp54f11a['APPID'] . '&redirect_uri=' . urlencode($spd7f811) . '&response_type=code&scope=snsapi_base#wechat_redirect'; if (!isset($_GET['code'])) { header('Location: ' . $sp05569a); die; } $sp90f038 = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=' . $sp54f11a['APPID'] . '&secret=' . $sp54f11a['APPSECRET'] . '&code=' . $_GET['code'] . '&grant_type=authorization_code'; $sp27b5c4 = @json_decode(CurlRequest::get($sp90f038), true); if (!$sp27b5c4 || !isset($sp27b5c4['openid'])) { if (isset($sp27b5c4['errcode']) && $sp27b5c4['errcode'] === 40163) { header('Location: ' . $sp05569a); die; } die('<h1>获取微信OPENID<br>错误信息: ' . (isset($sp27b5c4['errcode']) ? $sp27b5c4['errcode'] : $sp27b5c4) . '<br>' . (isset($sp27b5c4['errmsg']) ? $sp27b5c4['errmsg'] : $sp27b5c4) . '<br>请返回重试</h1>'); } $sp2cc24e = $sp27b5c4['openid']; } $this->defineWxConfig($sp54f11a); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxPay.NativePay.php'; require_once 'wxLog.php'; $sp58471a = new \NativePay(); $sp63ca0e = new \WxPayUnifiedOrder(); $sp63ca0e->SetBody($sp942f8c); $sp63ca0e->SetAttach($spd2bbfa); $sp63ca0e->SetOut_trade_no($spd2bbfa); $sp63ca0e->SetTotal_fee($sp488d84); $sp63ca0e->SetTime_start(date('YmdHis')); $sp63ca0e->SetTime_expire(date('YmdHis', time() + 600)); $sp63ca0e->SetGoods_tag('pay'); $sp63ca0e->SetNotify_url($this->url_notify); $sp63ca0e->SetTrade_type($sp286f3b); if ($sp286f3b === 'MWEB') { $sp63ca0e->SetScene_info('{"h5_info": {"type":"Wap","wap_url": "' . SYS_URL . '","wap_name": "发卡平台"}}'); } if ($sp286f3b === 'JSAPI') { $sp63ca0e->SetOpenid($sp2cc24e); } $sp63ca0e->SetProduct_id($spd2bbfa); $sp63ca0e->SetSpbill_create_ip(Helper::getIP()); $spfe67da = $sp58471a->unifiedOrder($sp63ca0e); function getValue($spd2bbfa, $spfe67da, $spc95936) { if (!isset($spfe67da[$spc95936])) { Log::error('Pay.WeChat.goPay, order_no:' . $spd2bbfa . ', error:' . json_encode($spfe67da)); if (isset($spfe67da['err_code_des'])) { throw new \Exception($spfe67da['err_code_des']); } if (isset($spfe67da['return_msg'])) { throw new \Exception($spfe67da['return_msg']); } throw new \Exception('获取支付数据失败'); } return $spfe67da[$spc95936]; } if ($sp286f3b === 'NATIVE') { $spadfef0 = getValue($spd2bbfa, $spfe67da, 'code_url'); header('Location: /qrcode/pay/' . $spd2bbfa . '/wechat?url=' . urlencode($spadfef0)); } elseif ($sp286f3b === 'JSAPI') { $sp636f0e = array('appId' => $sp54f11a['APPID'], 'timeStamp' => time(), 'nonceStr' => md5(time() . 'nonceStr'), 'package' => 'prepay_id=' . getValue($spd2bbfa, $spfe67da, 'prepay_id'), 'signType' => 'MD5'); $sp2bb3bd = new \WxPayJsApiPay(); $sp2bb3bd->FromArray($sp636f0e); $sp636f0e['paySign'] = $sp2bb3bd->MakeSign(); header('Location: /qrcode/pay/' . $spd2bbfa . '/wechat?url=' . urlencode(json_encode($sp636f0e))); } elseif ($sp286f3b === 'MWEB') { $spadfef0 = getValue($spd2bbfa, $spfe67da, 'mweb_url'); echo view('utils.redirect', array('url' => $spadfef0)); } die; } private function defineWxConfig($sp54f11a) { if (!defined('wx_APPID')) { define('wx_APPID', $sp54f11a['APPID']); } if (!defined('wx_MCHID')) { define('wx_MCHID', $sp54f11a['MCHID']); } if (!defined('wx_KEY')) { define('wx_KEY', $sp54f11a['KEY']); } if (!defined('wx_APPSECRET')) { define('wx_APPSECRET', $sp54f11a['APPSECRET']); } } function verify($sp54f11a, $sp0a40c9) { $sp60916b = isset($sp54f11a['isNotify']) && $sp54f11a['isNotify']; $this->defineWxConfig($sp54f11a); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'wxLog.php'; if ($sp60916b) { return (new PayNotifyCallBack($sp0a40c9))->Handle(false); } else { $spd2bbfa = @$sp54f11a['out_trade_no']; $sp63ca0e = new \WxPayOrderQuery(); $sp63ca0e->SetOut_trade_no($spd2bbfa); $spfe67da = \WxPayApi::orderQuery($sp63ca0e); if (array_key_exists('trade_state', $spfe67da) && $spfe67da['trade_state'] == 'SUCCESS') { call_user_func_array($sp0a40c9, array($spfe67da['out_trade_no'], $spfe67da['total_fee'], $spfe67da['transaction_id'])); return true; } else { return false; } } } }
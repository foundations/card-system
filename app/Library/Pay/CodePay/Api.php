<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp7a2170) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp7a2170; $this->url_return = SYS_URL . '/pay/return/' . $sp7a2170; } function goPay($sp54f11a, $spd2bbfa, $sp942f8c, $spd86457, $sp5f71a2) { $sp488d84 = sprintf('%.2f', $sp5f71a2 / 100); $spbb3dbe = $sp54f11a['id']; $sp5106e4 = $sp54f11a['key']; switch ($sp54f11a['payway']) { case 'alipay': $sp060035 = 1; break; case 'qq': $sp060035 = 2; break; case 'weixin': $sp060035 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp2bb3bd = array('id' => $spbb3dbe, 'pay_id' => $spd2bbfa, 'type' => $sp060035, 'price' => $sp488d84, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp2bb3bd); $spc768dc = ''; $sp0bcb87 = ''; foreach ($sp2bb3bd as $spc95936 => $spfa4469) { if ($spfa4469 == '' || $spc95936 == 'sign') { continue; } if ($spc768dc != '') { $spc768dc .= '&'; $sp0bcb87 .= '&'; } $spc768dc .= "{$spc95936}={$spfa4469}"; $sp0bcb87 .= "{$spc95936}=" . urlencode($spfa4469); } $sp4f4bed = $sp0bcb87 . '&sign=' . md5($spc768dc . $sp5106e4); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $sp4f4bed); die; } function verify($sp54f11a, $sp0a40c9) { $sp60916b = isset($sp54f11a['isNotify']) && $sp54f11a['isNotify']; $spbb3dbe = $sp54f11a['id']; $sp5106e4 = $sp54f11a['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $spc768dc = ''; foreach ($_POST as $spc95936 => $spfa4469) { if ($spfa4469 == '' || $spc95936 == 'sign') { continue; } if ($spc768dc) { $spc768dc .= '&'; } $spc768dc .= "{$spc95936}={$spfa4469}"; } if (!isset($_POST['pay_no']) || md5($spc768dc . $sp5106e4) != $_POST['sign']) { if ($sp60916b) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($sp60916b) { echo 'fail'; } return false; } $spd2bbfa = $_POST['pay_id']; $sp151a84 = intval((double) $_POST['price'] * 100); $spdc4c7a = $_POST['pay_no']; $sp0a40c9($spd2bbfa, $sp151a84, $spdc4c7a); if ($sp60916b) { echo 'success'; } return true; } } }
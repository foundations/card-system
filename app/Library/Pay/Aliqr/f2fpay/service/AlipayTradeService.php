<?php
require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . './../../AopSdk.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . './../model/result/AlipayF2FPayResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/result/AlipayF2FQueryResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/result/AlipayF2FRefundResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/result/AlipayF2FPrecreateResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/builder/AlipayTradeQueryContentBuilder.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/builder/AlipayTradeCancelContentBuilder.php'; require dirname(__FILE__) . DIRECTORY_SEPARATOR . '../config/config.php'; class AlipayTradeService { public $gateway_url = 'https://openapi.alipay.com/gateway.do'; public $notify_url; public $sign_type; public $alipay_public_key; public $private_key; public $appid; public $charset = 'UTF-8'; public $token = NULL; private $MaxQueryRetry; private $QueryDuration; public $format = 'json'; function __construct($spa44e81) { $this->gateway_url = $spa44e81['gatewayUrl']; $this->appid = $spa44e81['app_id']; $this->sign_type = $spa44e81['sign_type']; $this->private_key = $spa44e81['merchant_private_key']; $this->alipay_public_key = $spa44e81['alipay_public_key']; $this->charset = $spa44e81['charset']; $this->MaxQueryRetry = $spa44e81['MaxQueryRetry']; $this->QueryDuration = $spa44e81['QueryDuration']; $this->notify_url = $spa44e81['notify_url']; if (empty($this->appid) || trim($this->appid) == '') { throw new Exception('appid should not be NULL!'); } if (empty($this->private_key) || trim($this->private_key) == '') { throw new Exception('private_key should not be NULL!'); } if (empty($this->alipay_public_key) || trim($this->alipay_public_key) == '') { throw new Exception('alipay_public_key should not be NULL!'); } if (empty($this->charset) || trim($this->charset) == '') { throw new Exception('charset should not be NULL!'); } if (empty($this->QueryDuration) || trim($this->QueryDuration) == '') { throw new Exception('QueryDuration should not be NULL!'); } if (empty($this->gateway_url) || trim($this->gateway_url) == '') { throw new Exception('gateway_url should not be NULL!'); } if (empty($this->MaxQueryRetry) || trim($this->MaxQueryRetry) == '') { throw new Exception('MaxQueryRetry should not be NULL!'); } if (empty($this->sign_type) || trim($this->sign_type) == '') { throw new Exception('sign_type should not be NULL'); } } function AlipayWapPayService($spa44e81) { $this->__construct($spa44e81); } public function barPay($sp2cd750) { $sp9489f3 = $sp2cd750->getOutTradeNo(); $spc7d01c = $sp2cd750->getBizContent(); $sp460415 = $sp2cd750->getAppAuthToken(); $this->writeLog($spc7d01c); $spceaf29 = new AlipayTradePayRequest(); $spceaf29->setBizContent($spc7d01c); $sp651d08 = $this->aopclientRequestExecute($spceaf29, NULL, $sp460415); $sp651d08 = $sp651d08->alipay_trade_pay_response; $spfe67da = new AlipayF2FPayResult($sp651d08); if (!empty($sp651d08) && '10000' == $sp651d08->code) { $spfe67da->setTradeStatus('SUCCESS'); } elseif (!empty($sp651d08) && '10003' == $sp651d08->code) { $spcbe601 = new AlipayTradeQueryContentBuilder(); $spcbe601->setOutTradeNo($sp9489f3); $spcbe601->setAppAuthToken($sp460415); $spe1d97a = $this->loopQueryResult($spcbe601); return $this->checkQueryAndCancel($sp9489f3, $sp460415, $spfe67da, $spe1d97a); } elseif ($this->tradeError($sp651d08)) { $spcbe601 = new AlipayTradeQueryContentBuilder(); $spcbe601->setOutTradeNo($sp9489f3); $spcbe601->setAppAuthToken($sp460415); $sp201b03 = $this->query($spcbe601); return $this->checkQueryAndCancel($sp9489f3, $sp460415, $spfe67da, $sp201b03); } else { $spfe67da->setTradeStatus('FAILED'); } return $spfe67da; } public function queryTradeResult($sp2cd750) { $sp651d08 = $this->query($sp2cd750); $spfe67da = new AlipayF2FQueryResult($sp651d08); if ($this->querySuccess($sp651d08)) { $spfe67da->setTradeStatus('SUCCESS'); } elseif ($this->tradeError($sp651d08)) { $spfe67da->setTradeStatus('UNKNOWN'); } else { $spfe67da->setTradeStatus('FAILED'); } return $spfe67da; } public function refund($sp2cd750) { $spc7d01c = $sp2cd750->getBizContent(); $this->writeLog($spc7d01c); $spceaf29 = new AlipayTradeRefundRequest(); $spceaf29->setBizContent($spc7d01c); $sp651d08 = $this->aopclientRequestExecute($spceaf29, NULL, $sp2cd750->getAppAuthToken()); $sp651d08 = $sp651d08->alipay_trade_refund_response; $spfe67da = new AlipayF2FRefundResult($sp651d08); if (!empty($sp651d08) && '10000' == $sp651d08->code) { $spfe67da->setTradeStatus('SUCCESS'); } elseif ($this->tradeError($sp651d08)) { $spfe67da->setTradeStatus('UNKNOWN'); } else { $spfe67da->setTradeStatus('FAILED'); } return $spfe67da; } public function qrPay($sp2cd750) { $spc7d01c = $sp2cd750->getBizContent(); $this->writeLog($spc7d01c); $spceaf29 = new AlipayTradePrecreateRequest(); $spceaf29->setBizContent($spc7d01c); $spceaf29->setNotifyUrl($this->notify_url); $sp651d08 = $this->aopclientRequestExecute($spceaf29, NULL, $sp2cd750->getAppAuthToken()); $sp651d08 = $sp651d08->alipay_trade_precreate_response; $spfe67da = new AlipayF2FPrecreateResult($sp651d08); if (!empty($sp651d08) && '10000' == $sp651d08->code) { $spfe67da->setTradeStatus('SUCCESS'); } elseif ($this->tradeError($sp651d08)) { $spfe67da->setTradeStatus('UNKNOWN'); } else { $spfe67da->setTradeStatus('FAILED'); } return $spfe67da; } public function query($spcbe601) { $sp6edf63 = $spcbe601->getBizContent(); $this->writeLog($sp6edf63); $spceaf29 = new AlipayTradeQueryRequest(); $spceaf29->setBizContent($sp6edf63); $sp651d08 = $this->aopclientRequestExecute($spceaf29, NULL, $spcbe601->getAppAuthToken()); return $sp651d08->alipay_trade_query_response; } protected function loopQueryResult($spcbe601) { $spa864cf = NULL; for ($sp3f53b5 = 1; $sp3f53b5 < $this->MaxQueryRetry; $sp3f53b5++) { try { sleep($this->QueryDuration); } catch (Exception $spa0e498) { print $spa0e498->getMessage(); die; } $sp201b03 = $this->query($spcbe601); if (!empty($sp201b03)) { if ($this->stopQuery($sp201b03)) { return $sp201b03; } $spa864cf = $sp201b03; } } return $spa864cf; } protected function stopQuery($sp651d08) { if ('10000' == $sp651d08->code) { if ('TRADE_FINISHED' == $sp651d08->trade_status || 'TRADE_SUCCESS' == $sp651d08->trade_status || 'TRADE_CLOSED' == $sp651d08->trade_status) { return true; } } return false; } private function checkQueryAndCancel($sp9489f3, $sp460415, $spfe67da, $sp201b03) { if ($this->querySuccess($sp201b03)) { $spfe67da->setTradeStatus('SUCCESS'); $spfe67da->setResponse($sp201b03); return $spfe67da; } elseif ($this->queryClose($sp201b03)) { $spfe67da->setTradeStatus('FAILED'); return $spfe67da; } $sp7d4957 = new AlipayTradeCancelContentBuilder(); $sp7d4957->setAppAuthToken($sp460415); $sp7d4957->setOutTradeNo($sp9489f3); $sp5e3903 = $this->cancel($sp7d4957); if ($this->tradeError($sp5e3903)) { $spfe67da->setTradeStatus('UNKNOWN'); } else { $spfe67da->setTradeStatus('FAILED'); } return $spfe67da; } protected function querySuccess($sp201b03) { return !empty($sp201b03) && $sp201b03->code == '10000' && ($sp201b03->trade_status == 'TRADE_SUCCESS' || $sp201b03->trade_status == 'TRADE_FINISHED'); } protected function queryClose($sp201b03) { return !empty($sp201b03) && $sp201b03->code == '10000' && $sp201b03->trade_status == 'TRADE_CLOSED'; } protected function tradeError($sp651d08) { return empty($sp651d08) || $sp651d08->code == '20000'; } public function cancel($sp7d4957) { $sp6edf63 = $sp7d4957->getBizContent(); $this->writeLog($sp6edf63); $spceaf29 = new AlipayTradeCancelRequest(); $spceaf29->setBizContent($sp6edf63); $sp651d08 = $this->aopclientRequestExecute($spceaf29, NULL, $sp7d4957->getAppAuthToken()); return $sp651d08->alipay_trade_cancel_response; } private function aopclientRequestExecute($spceaf29, $spee8e3a = NULL, $sp460415 = NULL) { $sp9941e6 = new AopClient(); $sp9941e6->gatewayUrl = $this->gateway_url; $sp9941e6->appId = $this->appid; $sp9941e6->signType = $this->sign_type; $sp9941e6->rsaPrivateKey = $this->private_key; $sp9941e6->alipayrsaPublicKey = $this->alipay_public_key; $sp9941e6->apiVersion = '1.0'; $sp9941e6->postCharset = $this->charset; $sp9941e6->format = $this->format; $sp9941e6->debugInfo = true; $spfe67da = $sp9941e6->execute($spceaf29, $spee8e3a, $sp460415); return $spfe67da; } function writeLog($speaf35f) { file_put_contents(dirname(__FILE__) . '/../log/log.txt', date('Y-m-d H:i:s') . '  ' . $speaf35f . '
', FILE_APPEND); } function create_erweima($spb0c78a, $spf9945d = '200', $sp68802a = 'L', $spc9d8ae = '0') { $spb0c78a = urlencode($spb0c78a); $spffacf2 = '<img src="http://chart.apis.google.com/chart?chs=' . $spf9945d . 'x' . $spf9945d . '&amp;cht=qr&chld=' . $sp68802a . '|' . $spc9d8ae . '&amp;chl=' . $spb0c78a . '"  widht="' . $spf9945d . '" height="' . $spf9945d . '" />'; return $spffacf2; } function create_erweima_url($spb0c78a, $spf9945d = '200', $sp68802a = 'L', $spc9d8ae = '0') { $spb0c78a = urlencode($spb0c78a); $spffacf2 = 'http://chart.apis.google.com/chart?chs=' . $spf9945d . 'x' . $spf9945d . '&amp;cht=qr&chld=' . $sp68802a . '|' . $spc9d8ae . '&amp;chl=' . $spb0c78a; return $spffacf2; } }
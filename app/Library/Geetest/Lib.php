<?php
namespace App\Library\Geetest; class Lib { const GT_SDK_VERSION = 'php_3.2.0'; public static $connectTimeout = 1; public static $socketTimeout = 1; private $response; public $captcha_id; public $private_key; public function __construct($sp4bbb6e, $sp05e937) { $this->captcha_id = $sp4bbb6e; $this->private_key = $sp05e937; } public function pre_process($speb13d0 = null) { $spadfef0 = 'http://api.geetest.com/register.php?gt=' . $this->captcha_id; if ($speb13d0 != null and is_string($speb13d0)) { $spadfef0 = $spadfef0 . '&user_id=' . $speb13d0; } $sp881287 = $this->send_request($spadfef0); if (strlen($sp881287) != 32) { $this->failback_process(); return 0; } $this->success_process($sp881287); return 1; } private function success_process($sp881287) { $sp881287 = md5($sp881287 . $this->private_key); $spfe67da = array('success' => 1, 'gt' => $this->captcha_id, 'challenge' => $sp881287); $this->response = $spfe67da; } private function failback_process() { $spde14f4 = md5(rand(0, 100)); $sp977169 = md5(rand(0, 100)); $sp881287 = $spde14f4 . substr($sp977169, 0, 2); $spfe67da = array('success' => 0, 'gt' => $this->captcha_id, 'challenge' => $sp881287); $this->response = $spfe67da; } public function get_response_str() { return json_encode($this->response); } public function get_response() { return $this->response; } public function success_validate($sp881287, $spd01b7e, $sp7af29e, $speb13d0 = null) { if (!$this->check_validate($sp881287, $spd01b7e)) { return 0; } $sp2bb3bd = array('seccode' => $sp7af29e, 'sdk' => self::GT_SDK_VERSION); if ($speb13d0 != null and is_string($speb13d0)) { $sp2bb3bd['user_id'] = $speb13d0; } $spadfef0 = 'http://api.geetest.com/validate.php'; $sp1527b0 = $this->post_request($spadfef0, $sp2bb3bd); if ($sp1527b0 == md5($sp7af29e)) { return 1; } else { if ($sp1527b0 == 'false') { return 0; } else { return 0; } } } public function fail_validate($sp881287, $spd01b7e, $sp7af29e) { if ($spd01b7e) { $sp4d089d = explode('_', $spd01b7e); try { $sp0cab3a = $this->decode_response($sp881287, $sp4d089d['0']); $spd82a5b = $this->decode_response($sp881287, $sp4d089d['1']); $sp011dd8 = $this->decode_response($sp881287, $sp4d089d['2']); $sp66adcb = $this->get_failback_pic_ans($spd82a5b, $sp011dd8); $sp4e8034 = abs($sp0cab3a - $sp66adcb); } catch (\Exception $spa0e498) { return 1; } if ($sp4e8034 < 4) { return 1; } else { return 0; } } else { return 0; } } private function check_validate($sp881287, $spd01b7e) { if (strlen($spd01b7e) != 32) { return false; } if (md5($this->private_key . 'geetest' . $sp881287) != $spd01b7e) { return false; } return true; } private function send_request($spadfef0) { if (function_exists('curl_exec')) { $spe77a27 = curl_init(); curl_setopt($spe77a27, CURLOPT_URL, $spadfef0); curl_setopt($spe77a27, CURLOPT_CONNECTTIMEOUT, self::$connectTimeout); curl_setopt($spe77a27, CURLOPT_TIMEOUT, self::$socketTimeout); curl_setopt($spe77a27, CURLOPT_RETURNTRANSFER, 1); $sp2bb3bd = curl_exec($spe77a27); if (curl_errno($spe77a27)) { $sp5c660e = sprintf('curl[%s] error[%s]', $spadfef0, curl_errno($spe77a27) . ':' . curl_error($spe77a27)); $this->triggerError($sp5c660e); } curl_close($spe77a27); } else { $spe29f99 = array('http' => array('method' => 'GET', 'timeout' => self::$connectTimeout + self::$socketTimeout)); $sp1b3115 = stream_context_create($spe29f99); $sp2bb3bd = file_get_contents($spadfef0, false, $sp1b3115); } return $sp2bb3bd; } private function post_request($spadfef0, $sp83366c = '') { if (!$sp83366c) { return false; } $sp2bb3bd = http_build_query($sp83366c); if (function_exists('curl_exec')) { $spe77a27 = curl_init(); curl_setopt($spe77a27, CURLOPT_URL, $spadfef0); curl_setopt($spe77a27, CURLOPT_RETURNTRANSFER, 1); curl_setopt($spe77a27, CURLOPT_CONNECTTIMEOUT, self::$connectTimeout); curl_setopt($spe77a27, CURLOPT_TIMEOUT, self::$socketTimeout); if (!$sp83366c) { curl_setopt($spe77a27, CURLOPT_USERAGENT, $_SERVER['HTTP_USER_AGENT']); } else { curl_setopt($spe77a27, CURLOPT_POST, 1); curl_setopt($spe77a27, CURLOPT_POSTFIELDS, $sp2bb3bd); } $sp2bb3bd = curl_exec($spe77a27); if (curl_errno($spe77a27)) { $sp5c660e = sprintf('curl[%s] error[%s]', $spadfef0, curl_errno($spe77a27) . ':' . curl_error($spe77a27)); $this->triggerError($sp5c660e); } curl_close($spe77a27); } else { if ($sp83366c) { $spe29f99 = array('http' => array('method' => 'POST', 'header' => 'Content-type: application/x-www-form-urlencoded
' . 'Content-Length: ' . strlen($sp2bb3bd) . '
', 'content' => $sp2bb3bd, 'timeout' => self::$connectTimeout + self::$socketTimeout)); $sp1b3115 = stream_context_create($spe29f99); $sp2bb3bd = file_get_contents($spadfef0, false, $sp1b3115); } } return $sp2bb3bd; } private function decode_response($sp881287, $sp0af8e2) { if (strlen($sp0af8e2) > 100) { return 0; } $spc95936 = array(); $sp18ec87 = array(); $sp77f714 = array('0' => 1, '1' => 2, '2' => 5, '3' => 10, '4' => 50); $spded8d0 = 0; $sp5f9727 = 0; $sp46c3e8 = str_split($sp881287); $sp94d149 = str_split($sp0af8e2); for ($sp3f53b5 = 0; $sp3f53b5 < strlen($sp881287); $sp3f53b5++) { $sp83d892 = $sp46c3e8[$sp3f53b5]; if (in_array($sp83d892, $sp18ec87)) { continue; } else { $sp4d089d = $sp77f714[$spded8d0 % 5]; array_push($sp18ec87, $sp83d892); $spded8d0++; $spc95936[$sp83d892] = $sp4d089d; } } for ($spf894b1 = 0; $spf894b1 < strlen($sp0af8e2); $spf894b1++) { $sp5f9727 += $spc95936[$sp94d149[$spf894b1]]; } $sp5f9727 = $sp5f9727 - $this->decodeRandBase($sp881287); return $sp5f9727; } private function get_x_pos_from_str($sp122443) { if (strlen($sp122443) != 5) { return 0; } $sp0396b7 = 0; $sp226f8f = 200; $sp0396b7 = base_convert($sp122443, 16, 10); $spfe67da = $sp0396b7 % $sp226f8f; $spfe67da = $spfe67da < 40 ? 40 : $spfe67da; return $spfe67da; } private function get_failback_pic_ans($speefe88, $sp583e57) { $spe1415b = substr(md5($speefe88), 0, 9); $sp7fdf7b = substr(md5($sp583e57), 10, 9); $sp64c95d = ''; for ($sp3f53b5 = 0; $sp3f53b5 < 9; $sp3f53b5++) { if ($sp3f53b5 % 2 == 0) { $sp64c95d = $sp64c95d . $spe1415b[$sp3f53b5]; } elseif ($sp3f53b5 % 2 == 1) { $sp64c95d = $sp64c95d . $sp7fdf7b[$sp3f53b5]; } } $spe5fd97 = substr($sp64c95d, 4, 5); $sp66adcb = $this->get_x_pos_from_str($spe5fd97); return $sp66adcb; } private function decodeRandBase($sp881287) { $sp8e19e6 = substr($sp881287, 32, 2); $sp3303a5 = array(); for ($sp3f53b5 = 0; $sp3f53b5 < strlen($sp8e19e6); $sp3f53b5++) { $sp2c8f87 = ord($sp8e19e6[$sp3f53b5]); $spfe67da = $sp2c8f87 > 57 ? $sp2c8f87 - 87 : $sp2c8f87 - 48; array_push($sp3303a5, $spfe67da); } $spdd77c9 = $sp3303a5['0'] * 36 + $sp3303a5['1']; return $spdd77c9; } private function triggerError($sp5c660e) { } }
<?php
namespace App\Http\Controllers\Admin; use App\Library\Helper; use function foo\func; use Illuminate\Http\Request; use App\Http\Controllers\Controller; use App\Library\Response; class Pay extends Controller { function get(Request $spceaf29) { $sp4f4bed = \App\Pay::orderBy('sort'); $spb9f61b = $spceaf29->post('enabled'); if (strlen($spb9f61b)) { $sp4f4bed->whereIn('enabled', explode(',', $spb9f61b)); } $sp117844 = $spceaf29->post('search', false); if ($sp117844 == 'simple') { return Response::success($sp4f4bed->get(array('id', 'name'))); } $sp1447fb = $sp4f4bed->get(); return Response::success($sp1447fb); } function stat(Request $spceaf29) { $sp024af9 = (int) $spceaf29->input('day', 7); $sp1447fb = \App\Order::where(function ($sp4f4bed) { $sp4f4bed->where('status', \App\Order::STATUS_PAID)->orWhere('status', \App\Order::STATUS_SUCCESS); })->where('paid_at', '>=', Helper::getMysqlDate(-$sp024af9 + 1))->with(array('pay' => function ($sp4f4bed) { $sp4f4bed->select(array('id', 'name')); }))->groupBy('pay_id')->selectRaw('`pay_id`,COUNT(*) as "count",SUM(`paid`) as "sum"')->get()->toArray(); $sp27b5c4 = array(); foreach ($sp1447fb as $sp83d892) { if (isset($sp83d892['pay']) && isset($sp83d892['pay']['name'])) { $sp74a832 = $sp83d892['pay']['name']; } else { $sp74a832 = '未知方式#' . $sp83d892['pay_id']; } $sp27b5c4[$sp74a832] = array((int) $sp83d892['count'], (int) $sp83d892['sum']); } return Response::success($sp27b5c4); } function edit(Request $spceaf29) { $this->validate($spceaf29, array('id' => 'required|integer', 'name' => 'required|string', 'img' => 'required|string', 'driver' => 'required|string', 'way' => 'required|string', 'config' => 'required|string')); $sp7a2170 = (int) $spceaf29->post('id'); $sp3d006c = $spceaf29->post('name'); $sp6171d5 = $spceaf29->post('img'); $spaa0b0e = $spceaf29->post('comment'); $spb504ee = $spceaf29->post('driver'); $sp6101a1 = $spceaf29->post('way'); $sp54f11a = $spceaf29->post('config'); $spb9f61b = (int) $spceaf29->post('enabled'); $sp24c25b = \App\Pay::find($sp7a2170); if (!$sp24c25b) { $sp24c25b = new \App\Pay(); } $sp24c25b->name = $sp3d006c; $sp24c25b->img = $sp6171d5; $sp24c25b->comment = $spaa0b0e; $sp24c25b->driver = $spb504ee; $sp24c25b->way = $sp6101a1; $sp24c25b->config = $sp54f11a; $sp24c25b->enabled = $spb9f61b; $sp24c25b->fee_system = $spceaf29->post('fee_system'); $sp24c25b->saveOrFail(); return Response::success(); } function comment(Request $spceaf29) { $sp7a2170 = (int) $spceaf29->post('id', -1); if (!$sp7a2170) { return Response::forbidden(); } $sp24c25b = \App\Pay::findOrFail($sp7a2170); $sp24c25b->comment = $spceaf29->post('comment'); $sp24c25b->save(); return Response::success(); } function sort(Request $spceaf29) { $sp7a2170 = (int) $spceaf29->post('id', -1); if (!$sp7a2170) { return Response::forbidden(); } $sp24c25b = \App\Pay::findOrFail($sp7a2170); $sp24c25b->sort = (int) $spceaf29->post('sort', 1000); $sp24c25b->save(); return Response::success(); } function fee_system(Request $spceaf29) { $sp7a2170 = (int) $spceaf29->post('id'); if ($sp7a2170 < 1) { return Response::forbidden(); } $sp24c25b = \App\Pay::findOrFail($sp7a2170); $sp24c25b->fee_system = $spceaf29->post('fee_system'); $sp24c25b->saveOrFail(); return Response::success(); } function enable(Request $spceaf29) { $sp7824ec = $spceaf29->post('ids'); if (strlen($sp7824ec) < 1) { return Response::forbidden(); } $spb9f61b = (int) $spceaf29->post('enabled'); \App\Pay::whereIn('id', explode(',', $sp7824ec))->update(array('enabled' => $spb9f61b)); return Response::success(); } function delete(Request $spceaf29) { $sp7a2170 = (int) $spceaf29->post('id'); if ($sp7a2170 < 1) { return Response::forbidden(); } \App\Pay::whereId($sp7a2170)->delete(); return Response::success(); } }
<?php
namespace App\Http\Controllers\Merchant; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function get(Request $spceaf29) { $sp4f4bed = $this->authQuery($spceaf29, \App\Coupon::class)->with(array('category' => function ($sp4f4bed) { $sp4f4bed->select(array('id', 'name')); }))->with(array('product' => function ($sp4f4bed) { $sp4f4bed->select(array('id', 'name')); })); $sp117844 = $spceaf29->post('search', false); $sp73df55 = $spceaf29->post('val', false); if ($sp117844 && $sp73df55) { if ($sp117844 == 'id') { $sp4f4bed->where('id', $sp73df55); } else { $sp4f4bed->where($sp117844, 'like', '%' . $sp73df55 . '%'); } } $sp8fc58d = (int) $spceaf29->post('category_id'); $spd185cc = $spceaf29->post('product_id', -1); if ($sp8fc58d > 0) { if ($spd185cc > 0) { $sp4f4bed->where('product_id', $spd185cc); } else { $sp4f4bed->where('category_id', $sp8fc58d); } } $sp5340de = $spceaf29->post('status'); if (strlen($sp5340de)) { $sp4f4bed->whereIn('status', explode(',', $sp5340de)); } $sp060035 = $spceaf29->post('type'); if (strlen($sp060035)) { $sp4f4bed->whereIn('type', explode(',', $sp060035)); } $sp4f4bed->orderByRaw('expire_at DESC,category_id,product_id,type,status'); $sp8485a5 = $spceaf29->post('current_page', 1); $sp1d597f = $spceaf29->post('per_page', 20); $sp1447fb = $sp4f4bed->paginate($sp1d597f, array('*'), 'page', $sp8485a5); return Response::success($sp1447fb); } function create(Request $spceaf29) { $spded8d0 = $spceaf29->post('count', 0); $sp060035 = (int) $spceaf29->post('type', \App\Coupon::TYPE_ONETIME); $sp16c9b6 = $spceaf29->post('expire_at'); $spb42fb3 = (int) $spceaf29->post('discount_val'); $spcd49ed = (int) $spceaf29->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); $spbff105 = $spceaf29->post('remark'); if ($spcd49ed === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($spb42fb3 < 1 || $spb42fb3 > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($spcd49ed === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($spb42fb3 < 1 || $spb42fb3 > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $sp8fc58d = (int) $spceaf29->post('category_id', -1); $spd185cc = (int) $spceaf29->post('product_id', -1); if ($sp060035 === \App\Coupon::TYPE_REPEAT) { $spc7b1c2 = $spceaf29->post('coupon'); if (!$spc7b1c2) { $spc7b1c2 = strtoupper(str_random()); } $spc0e8c3 = new \App\Coupon(); $spc0e8c3->user_id = $this->getUserIdOrFail($spceaf29); $spc0e8c3->category_id = $sp8fc58d; $spc0e8c3->product_id = $spd185cc; $spc0e8c3->coupon = $spc7b1c2; $spc0e8c3->type = $sp060035; $spc0e8c3->discount_val = $spb42fb3; $spc0e8c3->discount_type = $spcd49ed; $spc0e8c3->count_all = (int) $spceaf29->post('count_all', 1); if ($spc0e8c3->count_all < 1 || $spc0e8c3->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } $spc0e8c3->expire_at = $sp16c9b6; $spc0e8c3->saveOrFail(); return Response::success(array($spc0e8c3->coupon)); } elseif ($sp060035 === \App\Coupon::TYPE_ONETIME) { if (!$spded8d0) { return Response::forbidden('请输入生成数量'); } if ($spded8d0 > 100) { return Response::forbidden('每次生成不能大于100张'); } $spde79b3 = array(); $spa9b1e4 = array(); $speb13d0 = $this->getUserIdOrFail($spceaf29); $sp70f83a = Carbon::now(); for ($sp3f53b5 = 0; $sp3f53b5 < $spded8d0; $sp3f53b5++) { $spc0e8c3 = strtoupper(str_random()); $spa9b1e4[] = $spc0e8c3; $spde79b3[] = array('user_id' => $speb13d0, 'coupon' => $spc0e8c3, 'category_id' => $sp8fc58d, 'product_id' => $spd185cc, 'type' => $sp060035, 'discount_val' => $spb42fb3, 'discount_type' => $spcd49ed, 'status' => \App\Coupon::STATUS_NORMAL, 'remark' => $spbff105, 'created_at' => $sp70f83a, 'expire_at' => $sp16c9b6); } \App\Coupon::insert($spde79b3); return Response::success($spa9b1e4); } else { return Response::forbidden('unknown type: ' . $sp060035); } } function edit(Request $spceaf29) { $sp7a2170 = (int) $spceaf29->post('id'); $spc7b1c2 = $spceaf29->post('coupon'); $sp8fc58d = (int) $spceaf29->post('category_id', -1); $spd185cc = (int) $spceaf29->post('product_id', -1); $sp16c9b6 = $spceaf29->post('expire_at', NULL); $sp5340de = (int) $spceaf29->post('status', \App\Coupon::STATUS_NORMAL); $sp060035 = (int) $spceaf29->post('type', \App\Coupon::TYPE_ONETIME); $spb42fb3 = (int) $spceaf29->post('discount_val'); $spcd49ed = (int) $spceaf29->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); if ($spcd49ed === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($spb42fb3 < 1 || $spb42fb3 > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($spcd49ed === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($spb42fb3 < 1 || $spb42fb3 > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $spc0e8c3 = $this->authQuery($spceaf29, \App\Coupon::class)->find($sp7a2170); if ($spc0e8c3) { $spc0e8c3->coupon = $spc7b1c2; $spc0e8c3->category_id = $sp8fc58d; $spc0e8c3->product_id = $spd185cc; $spc0e8c3->status = $sp5340de; $spc0e8c3->type = $sp060035; $spc0e8c3->discount_val = $spb42fb3; $spc0e8c3->discount_type = $spcd49ed; if ($sp060035 === \App\Coupon::TYPE_REPEAT) { $spc0e8c3->count_all = (int) $spceaf29->post('count_all', 1); if ($spc0e8c3->count_all < 1 || $spc0e8c3->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } } if ($sp16c9b6) { $spc0e8c3->expire_at = $sp16c9b6; } $spc0e8c3->saveOrFail(); } else { $spb4bd4a = explode('
', $spc7b1c2); for ($sp3f53b5 = 0; $sp3f53b5 < count($spb4bd4a); $sp3f53b5++) { $sp4389d7 = str_replace('', '', trim($spb4bd4a[$sp3f53b5])); $spc0e8c3 = new \App\Coupon(); $spc0e8c3->coupon = $sp4389d7; $spc0e8c3->category_id = $sp8fc58d; $spc0e8c3->product_id = $spd185cc; $spc0e8c3->status = $sp5340de; $spc0e8c3->type = $sp060035; $spc0e8c3->discount_val = $spb42fb3; $spc0e8c3->discount_type = $spcd49ed; $spb4bd4a[$sp3f53b5] = $spc0e8c3; } \App\Product::find($spd185cc)->coupons()->saveMany($spb4bd4a); } return Response::success(); } function enable(Request $spceaf29) { $sp7824ec = $spceaf29->post('ids', ''); if (strlen($sp7824ec) < 1) { return Response::forbidden(); } $spb9f61b = (int) $spceaf29->post('enabled'); $this->authQuery($spceaf29, \App\Coupon::class)->whereIn('id', explode(',', $sp7824ec))->update(array('enabled' => $spb9f61b)); return Response::success(); } function delete(Request $spceaf29) { $sp7824ec = $spceaf29->post('ids', ''); if (strlen($sp7824ec) < 1) { return Response::forbidden(); } $this->authQuery($spceaf29, \App\Coupon::class)->whereIn('id', explode(',', $sp7824ec))->delete(); return Response::success(); } }
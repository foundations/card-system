<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spceaf29) { $sp8fc58d = (int) $spceaf29->post('category_id', -1); $spd185cc = (int) $spceaf29->post('product_id', -1); $spc7b1c2 = $spceaf29->post('coupon'); if (!$spc7b1c2) { return Response::fail('请输入优惠券'); } if ($sp8fc58d > 0) { $spb34970 = Category::findOrFail($sp8fc58d); $speb13d0 = $spb34970->user_id; } elseif ($spd185cc > 0) { $spafbdfd = Product::findOrFail($spd185cc); $speb13d0 = $spafbdfd->user_id; } else { return Response::fail('请先选择分类或商品'); } $spde79b3 = \App\Coupon::where('user_id', $speb13d0)->where('coupon', $spc7b1c2)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($spde79b3 as $spc7b1c2) { if ($spc7b1c2->category_id === -1 || $spc7b1c2->category_id === $sp8fc58d && ($spc7b1c2->product_id === -1 || $spc7b1c2->product_id === $spd185cc)) { $spc7b1c2->setVisible(array('discount_type', 'discount_val')); return Response::success($spc7b1c2); } } return Response::fail('优惠券信息无效'); } }